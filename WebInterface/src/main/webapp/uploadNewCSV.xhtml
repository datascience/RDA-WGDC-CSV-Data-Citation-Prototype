<!--
  ~ Copyright [2015] [Stefan Pröll]
  ~
  ~    Licensed under the Apache License, Version 2.0 (the "License");
  ~    you may not use this file except in compliance with the License.
  ~    You may obtain a copy of the License at
  ~
  ~        http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~    Unless required by applicable law or agreed to in writing, software
  ~    distributed under the License is distributed on an "AS IS" BASIS,
  ~    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~    See the License for the specific language governing permissions and
  ~    limitations under the License.
  -->

<!--
  ~ Copyright [2015] [Stefan Pröll]
  ~
  ~    Licensed under the Apache License, Version 2.0 (the "License");
  ~    you may not use this file except in compliance with the License.
  ~    You may obtain a copy of the License at
  ~
  ~        http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~    Unless required by applicable law or agreed to in writing, software
  ~    distributed under the License is distributed on an "AS IS" BASIS,
  ~    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~    See the License for the specific language governing permissions and
  ~    limitations under the License.
  -->

<!--
  ~ Copyright [2015] [Stefan Pröll]
  ~
  ~    Licensed under the Apache License, Version 2.0 (the "License");
  ~    you may not use this file except in compliance with the License.
  ~    You may obtain a copy of the License at
  ~
  ~        http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~    Unless required by applicable law or agreed to in writing, software
  ~    distributed under the License is distributed on an "AS IS" BASIS,
  ~    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~    See the License for the specific language governing permissions and
  ~    limitations under the License.
  -->

<!--
  ~ Copyright [2015] [Stefan Pröll]
  ~
  ~    Licensed under the Apache License, Version 2.0 (the "License");
  ~    you may not use this file except in compliance with the License.
  ~    You may obtain a copy of the License at
  ~
  ~        http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~    Unless required by applicable law or agreed to in writing, software
  ~    distributed under the License is distributed on an "AS IS" BASIS,
  ~    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~    See the License for the specific language governing permissions and
  ~    limitations under the License.
  -->

<!--
  ~ Copyright [2015] [Stefan Pröll]
  ~
  ~    Licensed under the Apache License, Version 2.0 (the "License");
  ~    you may not use this file except in compliance with the License.
  ~    You may obtain a copy of the License at
  ~
  ~        http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~    Unless required by applicable law or agreed to in writing, software
  ~    distributed under the License is distributed on an "AS IS" BASIS,
  ~    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~    See the License for the specific language governing permissions and
  ~    limitations under the License.
  -->

<!--
  ~ Copyright [2015] [Stefan Pröll]
  ~
  ~    Licensed under the Apache License, Version 2.0 (the "License");
  ~    you may not use this file except in compliance with the License.
  ~    You may obtain a copy of the License at
  ~
  ~        http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~    Unless required by applicable law or agreed to in writing, software
  ~    distributed under the License is distributed on an "AS IS" BASIS,
  ~    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~    See the License for the specific language governing permissions and
  ~    limitations under the License.
  -->

<!--
  ~ Copyright [2015] [Stefan Pröll]
  ~
  ~    Licensed under the Apache License, Version 2.0 (the "License");
  ~    you may not use this file except in compliance with the License.
  ~    You may obtain a copy of the License at
  ~
  ~        http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~    Unless required by applicable law or agreed to in writing, software
  ~    distributed under the License is distributed on an "AS IS" BASIS,
  ~    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~    See the License for the specific language governing permissions and
  ~    limitations under the License.
  -->

<!--
  ~ Copyright [2015] [Stefan Pröll]
  ~
  ~    Licensed under the Apache License, Version 2.0 (the "License");
  ~    you may not use this file except in compliance with the License.
  ~    You may obtain a copy of the License at
  ~
  ~        http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~    Unless required by applicable law or agreed to in writing, software
  ~    distributed under the License is distributed on an "AS IS" BASIS,
  ~    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~    See the License for the specific language governing permissions and
  ~    limitations under the License.
  -->

<!--
  ~ Copyright [2015] [Stefan Pröll]
  ~
  ~    Licensed under the Apache License, Version 2.0 (the "License");
  ~    you may not use this file except in compliance with the License.
  ~    You may obtain a copy of the License at
  ~
  ~        http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~    Unless required by applicable law or agreed to in writing, software
  ~    distributed under the License is distributed on an "AS IS" BASIS,
  ~    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~    See the License for the specific language governing permissions and
  ~    limitations under the License.
  -->

<html xmlns:h="http://java.sun.com/jsf/html"
      xmlns:f="http://java.sun.com/jsf/core"
      xmlns:p="http://primefaces.org/ui"
      xmlns:ui="http://java.sun.com/jsf/facelets"
      xmlns="http://www.w3.org/1999/xhtml"
        >

<h:head>
    <title>CSV Data Upload</title>
    <link type="text/css" rel="stylesheet" href="css/csv-citation-custom.css"/>

    <style type="text/css">
        .column1{width: 200px;height:auto}
        .column2{width: 500px;height:auto}
        .column3{width: 20px;height:auto}

    </style>
</h:head>

<h:body>

    <!-- BEGIN: Hidden Form for Init-->
    <h:form>
        <p:remoteCommand name="onLoad" actionListener="#{databaseTableNameBean.onLoad}" autoRun="true"/>
        <p:remoteCommand name="onLoad" actionListener="#{fileUploadController.onLoad}" autoRun="true"/>
    </h:form>
    <!-- END Hidden form-->

    <script type="text/javascript">

    function predefineTableName(){
        alert("yay");
    }

</script>


    <div class="container">

        <!-- BEGIN user management -->
        <ui:include src="/topmenu.xhtml"/>
        <!-- END user management -->

        <h1>CSV Datafile Upload</h1>

        <p>With this you can upload a CSV file into the system. You need to select a database schema where you want to
            store
            the file and then specify a table name.<br></br> Please only chose table names starting with an alphabetical
            identifier (e.g. csv_measurement).<br></br> The system will create a new table with this name. Existing
            tables
            with the
            same name will be dropped and replaced.
        </p>


        <h2>Step 1: The Database Table Definition</h2>

        <p>Please select the database which should store your data. Use CITATION_DB in most cases. A tablename must
            start with an alphabetical letter and may then only consist of alphanummeric characters and underscores. 
            Alsp provide the name of the data author (creator).
        </p>



            <h2>Step 2: Upload the data</h2>

        <p>Select one file from your hard disk. It will be uploaded to the systems and analyzed. The system currently
            only supports a single file per upload.</p>

        <h:form id="fileUploadForm" enctype="multipart/form-data">
            <p:panel header="Dataset Metadata" style="width: 800px;">
                <p:messages autoUpdate="true"/>
                <h:panelGrid columns="5" cellpadding="5" columnClasses="column1,column2,column3,column3,column3"
                             style="width: 100%">


                    <p:outputLabel for="datasetInput" value="Dataset title"/>
                    <p:inputText id="datasetInput" required="true" requiredMessage="A title is required"
                                 value="#{fileUploadController.dataSetTitle}"
                                 title="Give a title for the dataset. It will appear in citations." 
                                 oncomplete="predefineTableName()">
                            <p:ajax event="keyup" listener="#{fileUploadController.updateTableNameInput}"        
                                    update="tableNameInput" />
                    </p:inputText>
                    
                    <p:tooltip id="datasetInputTipp" for="datasetInput" showEvent="focus" hideEvent="blur" />
                    <p:message for="datasetInput" />
                    <h:outputText value="#{validationView.text}" />
                    
                    
                    <p:outputLabel for="tableNameInput" value="Tablename"/>
                    <p:inputText id="tableNameInput" required="true" requiredMessage="The table name is required"
                                 value="#{fileUploadController.tableNameInput}" 
                                 title="This specifies the name of the table in the database which stores the records of the CSV file"/>
                    <p:tooltip id="tableNameInputTipp" for="tableNameInput" showEvent="focus" hideEvent="blur" />
                    <p:message for="tableNameInput" />
                    <h:outputText value="#{validationView.text}" />


                    <p:outputLabel for="authorInput" value="Author"/>
                    <p:inputText id="authorInput" required="true" requiredMessage="An author is required"
                                 value="#{fileUploadController.dataSetAuthor}" 
                                 title="Provide the name of the author of the dataset you upload here. This will also be the author mentioned in the generated citation text."/>
                    <p:message for="authorInput" />
                    <p:tooltip id="authorInputTipp" for="authorInput" showEvent="focus" hideEvent="blur" />
                    <h:outputText value="#{validationView.text}" />


                    <p:outputLabel for="descriptionInput" value="Description"/>
                    <p:inputTextarea
                            id="descriptionInput"
                            value="#{fileUploadController.dataSetDescription}"
                            styleClass="no-border" readonly="false"
                            style="width: 80%;height: 100%;"
                            rows="10"
                            required="true"
                            requiredMessage="A description is required"
                            title="Describe your dataset here."/>

                    <p:tooltip id="descriptionInputTipp" for="descriptionInput" showEvent="focus" hideEvent="blur" />
                    <p:message for="descriptionInput" />
                    <h:outputText value="#{validationView.text}" />


                        <p:outputLabel for="fileUpload" value="Upload a CSV file"/>
                        <p:fileUpload id="fileUpload" 
                                      value="#{fileUploadController.uploadedFile}"
                                      fileUploadListener="#{fileUploadController.handleFileUpload}"
                                      mode="advanced"
                                      update=":primaryKeyForm:primaryKeyMultiCheckbox,messagesUpload"
                                      auto="true"
                                      sizeLimit="300000000"
                                      allowTypes="/(\.|\/)(csv|txt)$/" ajax="true"
                                      required="true"
                                      requiredMessage="You need to upload a file"
                                      title="Upload a CSV file here."
                                />
                    <p:tooltip id="fileUploadTipp" for="fileUpload" showEvent="focus" hideEvent="blur" />
                    <p:message for="fileUpload" />
                    <h:outputText value="#{validationView.text}" />






                    <p:outputLabel for="tableDefinitionButton" value="Store file"/>
                    <p:commandButton id="tableDefinitionButton" value="Analyze"
                                     action="#{fileUploadController.finalizeFileUpload}" update=":primaryKeyForm:primaryKeyMultiCheckbox,messagesUpload"/>




            <p:growl id="messagesUpload" showDetail="true"/>
            <f:attribute name="uploadSessionType" value="newCSV"/>

            </h:panelGrid>
        </p:panel>
    </h:form>

        <h3>Sample datasets</h3>

        <p>
            <f:view contentType="text/html">
                You can download one of the following sample datasets from the links below.<br></br>
                <ul>
                    <li><a target="_blank" href="http://www.datacitation.eu/downloads/addresses.csv">Addresses (1k)</a>Testdataset
                    </li>
                    <li><a target="_blank" href="http://www.datacitation.eu/downloads/factbook.csv">World Factbook</a>
                        Adapted from this <a
                                href="http://perso.telecom-paristech.fr/~eagan/class/as2013/inf229/labs/datasets">source</a>
                    </li>
                    <li><a target="_blank" href="http://www.datacitation.eu/downloads/WHO.csv">WHO Health DataSet</a>
                        Adapted from this <a href="http://www.exploredata.net/Downloads/WHO-Data-Set">source</a></li>
                    <li><a target="_blank" href="http://www.datacitation.eu/downloads/WHO_simple.csv">Simplified WHO
                        Health DataSet</a>
                        Adapted from this <a href="http://www.exploredata.net/Downloads/WHO-Data-Set">source</a></li>
                    <li><a target="_blank" href="http://www.datacitation.eu/downloads/msd1k.csv">MSD 1k subset</a></li>
                    <li><a target="_blank" href="http://www.datacitation.eu/downloads/msd10k.csv">MSD 10k subset</a>
                    </li>
                    <li><a target="_blank" href="http://www.datacitation.eu/downloads/msd100k.csv">MSD 100k subset</a>
                    </li>
                </ul>

            </f:view>


        </p>
        
        <p:separator/>
        <h2>Step 3: Choose the Primary Key</h2>

        <p> Be aware that a primary key and also a combination of key forming a compound primary key must be unique.
            <br></br> The
            system automatically creates an internal sequence number column. If you can't provide a unique column as
            primary key, you can select the insert sequence number as unique key.</p>
        <!-- primary column -->

        <p:messages autoUpdate="true" globalOnly="false" escape="false"/>
        <h:form id="primaryKeyForm">
            <p:growl id="msg" />
            
            <p:outputLabel value="Primary key"/>


            <h:selectManyCheckbox id="primaryKeyMultiCheckbox"
                                  value="#{fileUploadController.selectedPrimaryKeyColumns}" layout="pageDirection"
                                  required="true"
                                  requiredMessage="At least one column needs to be checked">
                <f:selectItems value="#{fileUploadController.columnsValue}"/>
                <p:ajax update="msg" />
                
            </h:selectManyCheckbox>
            <h:message for="primaryKeyMultiCheckbox"/>

        </h:form>

        <p:separator/>



        <h:form id="migrateForm">

            <h:panelGrid columns="2" cellpadding="5">


            <p:commandButton id="migrateButton" value="Migrate into Database."
                             action="#{databaseMigrationController.migrationController}"
                             update="migrationMessage"/>


                <p:ajaxStatus style="display:block;margin-bottom:2em;height:36;">
                    <f:facet name="default">
                        <h:outputText value=""/>
                    </f:facet>

                    <f:facet name="start">
                        <p:graphicImage name="images/ajax-loader.gif"/>
                    </f:facet>

                    <f:facet name="complete">
                        <h:outputText value=""/>
                    </f:facet>
                </p:ajaxStatus>
            </h:panelGrid>

            <p:message id="migrationMessage" for="migrateForm:migrateButton" showDetail="true" autoUpdate="true"
                       closable="true"
                       globalOnly="false" escape="false"/>
        </h:form>


    </div>
</h:body>
</html>

