<html xmlns:h="http://java.sun.com/jsf/html"
      xmlns:f="http://java.sun.com/jsf/core"
      xmlns:p="http://primefaces.org/ui"
      xmlns:ui="http://java.sun.com/jsf/facelets"
      xmlns="http://www.w3.org/1999/xhtml">


<h:head>
    <title>CSV Data Upload</title>
    <link type="text/css" rel="stylesheet" href="css/csv-citation-custom.css"/>


</h:head>

<h:body>

    <!-- BEGIN: Hidden Form for Init-->
    <h:form>
        <p:remoteCommand name="onLoad" actionListener="#{databaseTableNameBean.onLoad}" autoRun="true"/>
    </h:form>
    <!-- END Hidden form-->


    <div class="container">

        <!-- BEGIN user management -->
        <ui:include src="/topmenu.xhtml"/>
        <!-- END user management -->

        <h1>CSV Datafile Upload</h1>

        <p>With this you can upload a CSV file into the system. You need to select a database schema where you want to
            store
            the file and then specify a table name.<br></br> Please only chose table names starting with an alphabetical
            identifier (e.g. csv_measurement).<br></br> The system will create a new table with this name. Existing
            tables
            with the
            same name will be dropped and replaced.
        </p>


        <h2>Step 1: The Database Table Definition</h2>

        <p>Please select the database which should store your data. Use CITATION_DB in most cases. A tablename must
            start with an alphabetical letter and may then only consist of alphanummeric characters and underscores. 
            Alsp provide the name of the data author (creator).
        </p>
        <p:messages id="messages" showDetail="true" autoUpdate="true" closable="true" globalOnly="true"/>
        <h:form enctype="multipart/form-data">
            <p:outputLabel value="Database schema"/>
            <h:selectOneMenu id="databaseDropDown"
                             valueChangeListener="#{databaseTableNameBean.handleChangeDatabaseName}"
                             required="true" value="#{databaseTableNameBean.databaseName}"
                             binding="#{databaseNameDropdown}">
                <f:selectItems value="#{databaseTableNameBean.databaseNames}"/>
                <p:ajax update="databaseDropDown"/>
            </h:selectOneMenu>

            <p:outputLabel value="Tablename"/>
            <p:inputText required="true" requiredMessage="The table name is required"
                         value="#{fileUploadController.tableName}">
                <f:ajax event="blur"/>
            </p:inputText>
            <p:outputLabel value="Author"/>
            <p:inputText required="true" requiredMessage="An author is required"
                         value="#{fileUploadController.dataSetAuthor}">
                <f:ajax event="blur"/>
            </p:inputText>

            <h2>Step 2: Upload the data</h2>

            <p>Select one file from your hard disk. It will be uploaded to the systems and analyzed. The system
                currently
                only supports a single file per upload.
                <br></br></p>
            <p:fileUpload fileUploadListener="#{fileUploadController.handleFileUpload}"
                          mode="advanced" update=":primaryKeyForm:primaryKeyMultiCheckbox,messages, dt" auto="true"
                          sizeLimit="100000000"
                          allowTypes="/(\.|\/)(csv|txt)$/"/>
            <p:dataTable id="dt" var="filename" value="#{fileUploadController.filesListStrings}">
                <p:column>
                    #{filename}
                </p:column>

            </p:dataTable>


            <p:growl id="messages" showDetail="true"/>
            <f:attribute name="uploadSessionType" value="newCSV"/>

        </h:form>
        <p:separator/>
        <h2>Step 3: Choose the Primary Key</h2>

        <p> Be aware that a primary key and also a combination of key forming a compound primary key must be unique.
            <br></br> The
            system automatically creates an internal sequence number column. If you can't provide a unique column as
            primary key, you can select the insert sequence number as unique key.</p>
        <!-- primary column -->

        <h:form id="primaryKeyForm">
            <p:outputLabel value="Primary key"/>


            <h:selectManyCheckbox id="primaryKeyMultiCheckbox"
                                  value="#{fileUploadController.selectedPrimaryKeyColumns}">
                <f:selectItems value="#{fileUploadController.columnsValue}"/>
            </h:selectManyCheckbox>
            <p:commandButton id="primaryKeyButton" value="Select primary key."
                             action="#{fileUploadController.setPrimarKeyAction}" update="primaryKeyMessage">


            </p:commandButton>
            <p:message id="primaryKeyMessage" for="primaryKeyForm:primaryKeyButton" showDetail="true" autoUpdate="true"
                       closable="true"
                       globalOnly="false"/>
        </h:form>

        <p:separator/>
        <p:ajaxStatus style="display:block;margin-bottom:2em;height:48px;">
            <f:facet name="default">
                <h:outputText value="Status: StandBy"/>
            </f:facet>

            <f:facet name="start">
                <p:graphicImage name="images/ajax-loader.gif"/>
            </f:facet>

            <f:facet name="complete">
                <h:outputText value="Status: Completed"/>
            </f:facet>
        </p:ajaxStatus>

        <h:form id="migrateForm">
            <p:commandButton id="migrateButton" value="Migrate into Database."
                             action="#{databaseMigrationController.migrationController}"
                             update="migrationMessage"/>
            <p:commandButton action="table.xhtml?faces-redirect=true" value="View existing data"/>
            <p:message id="migrationMessage" for="migrateForm:migrateButton" showDetail="true" autoUpdate="true"
                       closable="true"
                       globalOnly="false"/>
        </h:form>

    </div>
</h:body>
</html>

