<!--
  ~ Copyright [2015] [Stefan PrÃ¶ll]
  ~
  ~    Licensed under the Apache License, Version 2.0 (the "License");
  ~    you may not use this file except in compliance with the License.
  ~    You may obtain a copy of the License at
  ~
  ~        http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~    Unless required by applicable law or agreed to in writing, software
  ~    distributed under the License is distributed on an "AS IS" BASIS,
  ~    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~    See the License for the specific language governing permissions and
  ~    limitations under the License.
  -->

<html xmlns:h="http://java.sun.com/jsf/html"
      xmlns:f="http://java.sun.com/jsf/core"
      xmlns:p="http://primefaces.org/ui"
      xmlns:ui="http://java.sun.com/jsf/facelets"
      xmlns="http://www.w3.org/1999/xhtml"
        >

<h:head>
    <title>CSV Data Upload</title>
    <link type="text/css" rel="stylesheet" href="css/csv-citation-custom.css"/>

    <style type="text/css">
        .column1{width: 200px;height:auto}
        .column2{width: 500px;height:auto}

    </style>
</h:head>

<h:body>

    <!-- BEGIN: Hidden Form for Init-->
    <h:form>
        <p:remoteCommand name="onLoad" actionListener="#{databaseTableNameBean.onLoad}" autoRun="true"/>
        <p:remoteCommand name="onLoad" actionListener="#{fileUploadController.onLoad}" autoRun="true"/>
    </h:form>
    <!-- END Hidden form-->


    <div class="container">

        <!-- BEGIN user management -->
        <ui:include src="/topmenu.xhtml"/>
        <!-- END user management -->

        <h1>CSV Datafile Upload</h1>

        <p>With this you can upload a CSV file into the system. You need to select a database schema where you want to
            store
            the file and then specify a table name.<br></br> Please only chose table names starting with an alphabetical
            identifier (e.g. csv_measurement).<br></br> The system will create a new table with this name. Existing
            tables
            with the
            same name will be dropped and replaced.
        </p>


        <h2>Step 1: The Database Table Definition</h2>

        <p>Please select the database which should store your data. Use CITATION_DB in most cases. A tablename must
            start with an alphabetical letter and may then only consist of alphanummeric characters and underscores. 
            Alsp provide the name of the data author (creator).
        </p>



            <h2>Step 2: Upload the data</h2>

        <p>Select one file from your hard disk. It will be uploaded to the systems and analyzed. The system currently
            only supports a single file per upload.</p>

        <h:form>

            <p:panel header="Dataset Metadata" style="width: 800px;">
                <h:panelGrid columns="2" cellpadding="5" columnClasses="column1,column2" style="width: 100%">

                    <p:outputLabel for="tableNameInput" value="Tablename"/>
                    <p:inputText id="tableNameInput" required="true" requiredMessage="The table name is required"
                                 value="#{tableDefinitionController.tableNameInput}"/>
                    <p:message for="tableNameInput" />
                    <h:outputText value="#{validationView.text}" />




                    <p:outputLabel for="authorInput" value="Author"/>
                    <p:inputText id="authorInput" required="true" requiredMessage="An author is required"
                                 value="#{tableDefinitionController.dataSetAuthor}"/>
                    <p:message for="authorInput" />
                    <h:outputText value="#{validationView.text}" />


                    <p:outputLabel for="datasetInput" value="Dataset title"/>
                    <p:inputText id="datasetInput" required="true" requiredMessage="A title is required"
                                 value="#{tableDefinitionController.dataSetTitle}"/>
                    <p:message for="datasetInput" />
                    <h:outputText value="#{validationView.text}" />



                    <p:outputLabel for="descriptionInput" value="Description"/>
                    <p:inputTextarea
                            id="descriptionInput"
                            value="#{tableDefinitionController.dataSetDescription}"
                            styleClass="no-border" readonly="false"
                            style="width: 80%;height: 100%;"
                            rows="10"
                            required="true"
                            requiredMessage="A title is required"
                            />
                    <p:message for="descriptionInput" />
                    <h:outputText value="#{validationView.text}" />




                </h:panelGrid>
            </p:panel>


            <p:fileUpload fileUploadListener="#{fileUploadController.handleFileUpload}"
                          mode="advanced" update=":primaryKeyForm:primaryKeyMultiCheckbox,messagesUpload, dt" auto="true"
                          sizeLimit="300000000"
                          allowTypes="/(\.|\/)(csv|txt)$/"/>
            <p:dataTable id="dt" var="filename" value="#{fileUploadController.filesListStrings}">
                <p:column>
                    #{filename}
                </p:column>

            </p:dataTable>


            <p:commandButton id="tableDefinitionButton" value="Set data."
                             action="#{tableDefinitionController.setTableDefinitionFormdata}"
                          >


            </p:commandButton>


            <p:growl id="messagesUpload" showDetail="true"/>
            <f:attribute name="uploadSessionType" value="newCSV"/>


       </h:form>

        <h3>Sample datasets</h3>

        <p>
            <f:view contentType="text/html">
                You can download one of the following sample datasets from the links below.<br></br>
                <ul>
                    <li><a target="_blank" href="http://www.datacitation.eu/downloads/addresses.csv">Addresses (1k)</a>Testdataset
                    </li>
                    <li><a target="_blank" href="http://www.datacitation.eu/downloads/factbook.csv">World Factbook</a>
                        Adapted from this <a
                                href="http://perso.telecom-paristech.fr/~eagan/class/as2013/inf229/labs/datasets">source</a>
                    </li>
                    <li><a target="_blank" href="http://www.datacitation.eu/downloads/WHO.csv">WHO Health DataSet</a>
                        Adapted from this <a href="http://www.exploredata.net/Downloads/WHO-Data-Set">source</a></li>
                    <li><a target="_blank" href="http://www.datacitation.eu/downloads/WHO_simple.csv">Simplified WHO
                        Health DataSet</a>
                        Adapted from this <a href="http://www.exploredata.net/Downloads/WHO-Data-Set">source</a></li>
                    <li><a target="_blank" href="http://www.datacitation.eu/downloads/msd1k.csv">MSD 1k subset</a></li>
                    <li><a target="_blank" href="http://www.datacitation.eu/downloads/msd10k.csv">MSD 10k subset</a>
                    </li>
                    <li><a target="_blank" href="http://www.datacitation.eu/downloads/msd100k.csv">MSD 100k subset</a>
                    </li>
                </ul>

            </f:view>


        </p>
        
        <p:separator/>
        <h2>Step 3: Choose the Primary Key</h2>

        <p> Be aware that a primary key and also a combination of key forming a compound primary key must be unique.
            <br></br> The
            system automatically creates an internal sequence number column. If you can't provide a unique column as
            primary key, you can select the insert sequence number as unique key.</p>
        <!-- primary column -->

        <h:form id="primaryKeyForm">
            <p:outputLabel value="Primary key"/>


            <h:selectManyCheckbox id="primaryKeyMultiCheckbox"
                                  value="#{fileUploadController.selectedPrimaryKeyColumns}" layout="pageDirection"
                                  required="true"
                                  requiredMessage="At least one column needs to be checked">
                <f:selectItems value="#{fileUploadController.columnsValue}"/>
            </h:selectManyCheckbox>
            <h:message for="primaryKeyMultiCheckbox"/>
            <p:commandButton id="primaryKeyButton" value="Select primary key."
                             action="#{fileUploadController.setPrimarKeyAction}" update="primaryKeyMessage">


            </p:commandButton>
            <p:message id="primaryKeyMessage" for="primaryKeyForm:primaryKeyButton" showDetail="true" autoUpdate="true"
                       closable="true"
                       globalOnly="false"/>
        </h:form>

        <p:separator/>



        <h:form id="migrateForm">

            <h:panelGrid columns="2" cellpadding="5">


            <p:commandButton id="migrateButton" value="Migrate into Database."
                             action="#{databaseMigrationController.migrationController}"
                             update="migrationMessage"/>

                <p:commandButton action="table.xhtml?faces-redirect=true" value="View existing data"/>

                <p:ajaxStatus style="display:block;margin-bottom:2em;height:36;">
                    <f:facet name="default">
                        <h:outputText value=""/>
                    </f:facet>

                    <f:facet name="start">
                        <p:graphicImage name="images/ajax-loader.gif"/>
                    </f:facet>

                    <f:facet name="complete">
                        <h:outputText value=""/>
                    </f:facet>
                </p:ajaxStatus>
            </h:panelGrid>

            <p:message id="migrationMessage" for="migrateForm:migrateButton" showDetail="true" autoUpdate="true"
                       closable="true"
                       globalOnly="false" escape="false"/>
        </h:form>


    </div>
</h:body>
</html>

